package apps

import (
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/subosito/gotenv"
)

func TestEtsyGetAndPopulateGTasksDetails(t *testing.T) {
	server := httptest.NewServer(http.HandlerFunc(func(rw http.ResponseWriter, req *http.Request) {
		// Send response to be tested
		rw.Header().Set("Content-Type", "application/json")
		if req.URL.String() == "/oauth/access_token" {
			rw.Write([]byte(`oauth_token=2e12b982f521fbb849f1eae2de95f2&oauth_token_secret=d57e7ed5d8`))
		} else if req.URL.String() == "/users/__SELF__" {
			rw.Write([]byte(`{"count":1,"results":[{"user_id":30546520,"login_name":"anumahesh",
			"primary_email":"anumahesh82@gmail.com","creation_tsz":1360825617,
			"user_pub_key":{"key":"-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAvBfMC6kwTFqIIZEsOedv\nfx6dOk3llr04\/ZEiF\/95dvbls0EiUDLCdAZKtPJ5lxyUJS6zPWmMEGhiBaQXylcF\nFnaffBtFZeosq2v4SnIKqCcRrd79WpHQE1WVzU7rZYUboVxFlv835HRKiNqNDaWU\nBOeF61\/G1p7DgI2BlPMv3H5eNSgvNw0DK4FNCXnmdSEmWRlJbDp2Wf6yjFijEl1f\nff53oi7tEO9TiZZSpSEFGUNdcpQwW7i0eiEDn9rrLAvjEMitUdPLG6G2hzED+3zQ\nQi\/aQfXJl0eknd7mRltX\/xblQr6eNjBaDSgQIs90opBTWAC0kI2J4LTYUenHHzgB\nxfPq12GFvkfTtrPfteAz+FAM\/sxxSWARz0UNtJf\/BxMF\/jKrd4527Qc+NjHXBX3J\nRj2LVKUjkv0muuzVGN7zIPe+RSfc6MGeKPDBv5wMQNqzOR272w5AGhOZtev04H7w\nYDBKVMHiRVSQc3Bs1YU5Q7AaRC8HFw+EkIlt7Yr5rg9nvwu9ogMm0rBh7zB9Z+Dw\ny8jh\/1Oif68NQ0LOejH9xxvVdbLV42jfFxje39jHEjSVEiefPn3WgOFKosNupBLs\nN+hc9sNSCg++BkyzuH3x2ZzzsZsDpYk4r9JKQgvdAbAW8r1bNsop+c7A2Hnhwkv3\njPLtZRc5oil\/THzS66v5\/SkCAwEAAQ==\n-----END PUBLIC KEY-----\n",
			"key_id":21414239070},"referred_by_user_id":null,"feedback_info":{"count":121,"score":100},
			"awaiting_feedback_count":0,"use_new_inventory_endpoints":true}],"params":{"user_id":"__SELF__"},
			"type":"User","pagination":{}}`))
		} else if req.URL.String() == "/users/30546520/profile" {
			rw.Write([]byte(`{"count":1,"results":[{"user_profile_id":30546520,"user_id":30546520,"login_name":"anumahesh",
			"bio":"&quot;All good things in life are unexpected.&quot;\r\n\r\nIt all began when I started sewing little dresses for my baby girl on my mom&#39;s sewing machine. I was soon hooked, totaly in love with creating a dress. It makes me feel like a magician to take fabric, which isn&#39;t much on its own, and create something some one can actually wear. To see a little girls smile when they put on a pretty dress is absolutely priceless.\r\nI live in the southernmost part of India in a state called Kerala. ","gender":"female","birth_month":"4","birth_day":"26","join_tsz":1360825617,"materials":"","country_id":null,"region":"","city":"India","location":null,"avatar_id":22826654,"transaction_buy_count":15,"transaction_sold_count":459,"is_seller":true,"image_url_75x75":"https:\/\/i.etsystatic.com\/iusa\/808775\/22826654\/iusa_75x75.22826654_hibm.jpg?version=0","first_name":"Anu","last_name":"Mahesh"}],
			"params":{"user_id":"30546520"},"type":"UserProfile","pagination":{}}`))
		} else if req.URL.String() == "/users/30546520/shops" {
			rw.Write([]byte(`{"count":1,"results":[{"shop_id":7836362,"shop_name":"Bubblinga","user_id":30546520,"creation_tsz":1367754499,"title":"Kids couture and Indian ethnic outfits","announcement":"Welcome! We do beautiful lehengas and other outfits for your little ones. \nOur designs are available in adult sizes too. \nI have a grown ups shop also on Etsy. \nhttps:\/\/www.etsy.com\/in-en\/shop\/GiaExquisiteIndian","currency_code":"USD","is_vacation":false,"vacation_message":null,"sale_message":"Thank you for choosing Bubblinga . The product will be shipped to you as soon as possible. Please dont hesitate to convo me for any questions you may have. Thank you again for shopping with us.","digital_sale_message":null,"last_updated_tsz":1569493225,"listing_active_count":141,"digital_listing_count":0,"login_name":"anumahesh","accepts_custom_requests":true,"policy_welcome":"Hello and welcome to my shop. I&#39;m so excited to be on Etsy doing what I love and even more excited that you are here. \r\n\r\nA lot of love and care goes into making each of these pretty little dresses. Every piece is handmade and I personally hand pick everything that goes into the dresses, right from the fabric to buttons.\r\n\r\nI buy fabric and materials from quality sources to ensure that the dress meets the highest quality standards. Every piece is crafted with care keeping in mind that a little girl will want to run, play and have fun in it.\r\n\r\nAll photographs are taken in natural light to ensure that the color seen is as close to actual as possible. However, there may be a slight difference due to viewing from different monitors.\r\n\r\nPlease convo me if you would like to sell Bubblinga dresses or would like a wholesale order.\r\n\r\n","policy_payment":"We accept paypal, direct deposits, money orders and cheques.\r\n\r\nPaypal \u2013 This is the preferred method for international buyers. You need not be a member of paypal to use this facility. Paypal does not work for domestic customers\r\n\r\nDirect deposits \u2013 Buyers in India can use this payment method.\r\n\r\nMoney Orders and Cheques \u2013 The processing of the order will start once I receive\/ process the money order or cheque.\r\n","policy_shipping":"I use Etsy provided address as the default shipping address. Please ensure that this address is correct. If you need the dress shipped to another address, please start a convo with me.\r\n\r\nThe item will be shipped within the processing time mentioned for each piece, once the transaction including payment is complete.\r\n\r\nAll packages are shipped from India as speed post. Delivery time within India should be 2-3 days with international orders taking 7-14 days approximately.\r\n\r\n**The time of arrival is approximate if you buy as a gift, kindly plan ahead to give shipping time.\r\n\r\n","policy_refunds":"Refunds\/ Exchange\r\n\r\n We offer a full refund or exchange in the following cases\r\n      1. item shipped is defective. \r\n     2. Shipped a totally different dress from the one you ordered.\r\n     3. Shipped a totally different color from the one you ordered. This does not include small shade differences in color due to different monitors.\r\n     4. Totally wrong size from the size you mentioned.\r\n This does not include slight variations in the measurements say 0.5&quot; as these are handmade and slight variations in size are possible.\r\n If you have not given us measurements and want us to use an age group ( say size 2T) we will not be accepting claims for length or width variation. \r\n\r\nTo avail the refund or exchange in the above cases, please contact me within 3 days of item receipt with the photos of the defect. \r\n\r\n\r\nMy policy is no refunds\/exchanges for all other cases. All my designs are made with the high quality of standard and we strive to make you happy. If you are truly unhappy we can work on providing you with a store credit for your purchase.\r\n\r\nWe will not be able to give you refunds for swatches or samples you ordered.\r\n\r\nLost in Mail: We accept responsibility for the item lost in mail and will give you a full refund for the item. We use shipping with tracking number always and always follow up to see that the customer has received it.\r\n\r\n","policy_additional":"\r\nCustom Orders\r\n\r\nSpecial Occasion custom clothing:\r\n\r\nI accept orders for custom clothing for special occasions like wedding, first communion and birthdays\r\n Please ensure that you allow enough time( 2-3 weeks plus shipping time) for the order as the process will take more time. I will try my best to make the dress as quick as possible \r\n\r\nFeedback\r\n\r\nPlease kindly contact me first if you are not completely satisfied with your purchase. I&#39;m always here to hear you & help you.\r\n\r\n\r\nplease convo me for wholesale orders.\r\n\r\n\r\n\r\n\r\n\r\n","policy_seller_info":"","policy_updated_tsz":1413403431,"policy_has_private_receipt_info":false,"vacation_autoreply":null,"url":"https:\/\/www.etsy.com\/shop\/Bubblinga?utm_source=tailoringshoporderma&utm_medium=api&utm_campaign=api","image_url_760x100":"https:\/\/i.etsystatic.com\/iusb\/be2b94\/14491265\/iusb_760x100.14491265_95rz.jpg?version=0","num_favorers":935,"languages":["en-US"],"upcoming_local_event_id":null,"icon_url_fullxfull":"https:\/\/i.etsystatic.com\/isla\/95d418\/33266342\/isla_fullxfull.33266342_325wwnni.jpg?version=0","is_using_structured_policies":false,"has_onboarded_structured_policies":false,"has_unstructured_policies":true,"include_dispute_form_link":false,"use_new_inventory_endpoints":true,"is_direct_checkout_onboarded":false,"policy_privacy":null,"is_calculated_eligible":false,"is_opted_in_to_buyer_promise":true,"is_shop_us_based":false}],"params":{"user_id":"30546520","limit":25,"offset":0,"page":null},"type":"Shop","pagination":{"effective_limit":25,"effective_offset":0,"next_offset":null,"effective_page":1,"next_page":null}}`))
		} else {
			assert.Fail(t, "Unknown http request from unit")
		}
	}))
	defer server.Close()
	gotenv.OverApply(strings.NewReader("ETSY_TOKEN_BASE_URL=" + server.URL + "/"))
	appMgr := GetAppManager(Etsy)
	err := appMgr.GetAndPopulateAppDetails(buildDummyUserInfo(), httptest.NewRequest("GET",
		"http://localhost/apps/gtask/callback?oauth_token=abcd&oauth_verifier=efgh", nil), "abcd")
	assert.Nil(t, err)
}
